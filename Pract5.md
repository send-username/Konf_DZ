# Практическое занятие №5. Вопросы виртуализации

## Задача 1

Исследование виртуальной стековой машины CPython.

Изучите возможности просмотра байткода ВМ CPython.

import dis

def foo(x):
    while x:
        x -= 1
    return x + 1

print(dis.dis(foo))


Опишите по шагам, что делает каждая из следующих команд (приведите эквивалентное выражение на Python):
 11           0 LOAD_FAST                0 (x)
              2 LOAD_CONST               1 (10)
              4 BINARY_MULTIPLY
              6 LOAD_CONST               2 (42)
              8 BINARY_ADD
             10 RETURN_VALUE


## Решение:

### Байткод:

11  0 LOAD_FAST                0 (x)           # Загружает значение переменной x (0 - это индекс переменной)
    2 LOAD_CONST               1 (10)          # Загружает константу 10
    4 BINARY_MULTIPLY                          # Умножает значение x на 10
    6 LOAD_CONST               2 (42)          # Загружает константу 42
    8 BINARY_ADD                               # Сложение результата предыдущего умножения с 42
   10 RETURN_VALUE                             # Возвращает итоговое значение


### Описание команд:

Допустим, при x = 7:

1. 11 0 LOAD_FAST 0 (x)  
   Загружает значение переменной x (в данном случае 7) на стек.

2. 2 LOAD_CONST 1 (10)  
   Загружает константу 10 на стек.

3. 4 BINARY_MULTIPLY  
   Умножает два верхних значения на стеке: 7 * 10, что дает 70. Результат 70 помещается на вершину стека.

4. 6 LOAD_CONST 2 (42)  
   Загружает константу 42 на стек.

5. 8 BINARY_ADD  
   Складывает два верхних значения на стеке: 70 + 42, что дает 112. Результат 112 становится новым верхним значением стека.

6. 10 RETURN_VALUE  
   Возвращает верхнее значение со стека, т.е. 112, как результат функции.

Эквивалентный Python-код при x = 7:

result = (7 * 10) + 42  # result = 70 + 42 = 112
return result


Результат выполнения кода: 112.


## Задача 2

Что делает следующий байткод (опишите шаги его работы)? Это известная функция, назовите ее.

  5           0 LOAD_CONST               1 (1)
              2 STORE_FAST               1 (r)

  6     >>    4 LOAD_FAST                0 (n)
              6 LOAD_CONST               1 (1)
              8 COMPARE_OP               4 (>)
             10 POP_JUMP_IF_FALSE       30

  7          12 LOAD_FAST                1 (r)
             14 LOAD_FAST                0 (n)
             16 INPLACE_MULTIPLY
             18 STORE_FAST               1 (r)

  8          20 LOAD_FAST                0 (n)
             22 LOAD_CONST               1 (1)
             24 INPLACE_SUBTRACT
             26 STORE_FAST               0 (n)
             28 JUMP_ABSOLUTE            4

  9     >>   30 LOAD_FAST                1 (r)
             32 RETURN_VALUE


## Решение:

Этот байткод представляет собой реализацию известной функции — факториала.

### Описание байткода и его эквивалента на Python:

Функция рассчитывает факториал числа n в императивном стиле (с использованием цикла).

#### Байткод с комментариями:

```python
  5           0 LOAD_CONST               1 (1)      # Загружает константу 1
              2 STORE_FAST               1 (r)      # Сохраняет значение 1 в переменную r

  6     >>    4 LOAD_FAST                0 (n)      # Загружает значение n
              6 LOAD_CONST               1 (1)      # Загружает константу 1
              8 COMPARE_OP               4 (>)      # Проверяет, больше ли n 1
             10 POP_JUMP_IF_FALSE       30          # Если n <= 1, переходит к адресу 30 (завершение)

  7          12 LOAD_FAST                1 (r)      # Загружает значение r
             14 LOAD_FAST                0 (n)      # Загружает значение n
             16 INPLACE_MULTIPLY                      # Умножает r на n
             18 STORE_FAST               1 (r)      # Сохраняет результат обратно в r

  8
